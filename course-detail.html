<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EduPro - Course Details</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      /* small animation */
      .fade-in {
        animation: fadeIn 0.32s ease both;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }

      /* small focus ring for keyboard users */
      .focus-ring:focus {
        outline: 3px solid rgba(59, 130, 246, 0.35);
        outline-offset: 2px;
      }

      /* modal utilities */
      .modal-hidden {
        display: none;
      }
      .modal-flex {
        display: flex;
      }
    </style>
  </head>

  <body class="bg-gray-50 text-gray-800 font-sans flex flex-col min-h-screen">
    <nav class="bg-white shadow-md fixed w-full z-50 top-0 left-0">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <a href="index.html" class="text-2xl font-bold text-blue-600"
              ><i class="fas fa-graduation-cap"></i> EduPro</a
            >
          </div>
          <div class="hidden md:flex items-center space-x-8">
            <a href="index.html" class="text-gray-600 hover:text-blue-600"
              >Home</a
            >
            <a href="courses.html" class="text-blue-600 font-semibold"
              >Courses</a
            >
            <a
              href="dashboard.html"
              class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
              >Dashboard</a
            >
          </div>
          <div class="md:hidden flex items-center">
            <button
              id="mobile-menu-btn"
              class="text-gray-600 hover:text-blue-600 focus:outline-none"
            >
              <i class="fas fa-bars text-2xl"></i>
            </button>
          </div>
        </div>
      </div>
      <div
        id="mobile-menu"
        class="hidden md:hidden bg-white pb-4 px-4 border-t"
      >
        <a href="index.html" class="block py-2 text-gray-600">Home</a>
        <a href="courses.html" class="block py-2 text-blue-600 font-bold"
          >Courses</a
        >
        <a href="dashboard.html" class="block py-2 text-gray-600">Dashboard</a>
      </div>
    </nav>

    <main
      class="pt-24 pb-12 max-w-7xl mx-auto px-4 flex-grow"
      id="course-detail-container"
    >
      <div class="bg-white p-8 rounded-xl shadow-lg text-center text-gray-500">
        Loading course details...
      </div>
    </main>

    <footer class="bg-gray-800 text-white py-8 text-center mt-auto">
      <p>&copy; 2025 EduPro LMS. All rights reserved.</p>
    </footer>

    <!-- lightweight loader pattern (keeps existing behavior) -->
    <script>
      (function () {
        try {
          if (!localStorage.getItem("lmsCourses")) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "courses.json", false);
            xhr.send(null);
            if (xhr.status >= 200 && xhr.status < 300) {
              localStorage.setItem("lmsCourses", xhr.responseText);
            } else {
              console.warn("courses.json load failed, status:", xhr.status);
            }
          }
        } catch (e) {
          console.error("Synchronous load failed:", e);
        }
        try {
          window.coursesData = JSON.parse(
            localStorage.getItem("lmsCourses") || "[]"
          );
        } catch (e) {
          console.error("Failed to parse lmsCourses:", e);
          window.coursesData = [];
        }
      })();
    </script>

    <script src="script.js"></script>

    <script>
      /* ------------------------------------------------------------
         Course Detail page: cleaned certificate wiring and central APIs
         ------------------------------------------------------------ */

      // Helpers
      function escapeHtml(str) {
        if (typeof str !== "string") return str;
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Get params and data
      const params = new URLSearchParams(window.location.search);
      const cId = parseInt(params.get("id"), 10);
      const certIdQuery = params.get("certId");
      const container = document.getElementById("course-detail-container");
      const currentUser =
        typeof getCurrentUser === "function" ? getCurrentUser() : null;

      // Defensive: require course exists
      const course = (window.coursesData || []).find((c) => c.id === cId);

      // Render UI
      function renderCourseDetail() {
        if (!course) {
          container.innerHTML = `
            <div class="bg-white p-8 rounded-xl shadow-lg text-center text-red-500">
              Course not found (ID: ${escapeHtml(String(cId))}).
            </div>`;
          return;
        }

        // Safe progress object
        const progress =
          (typeof getProgress === "function" ? getProgress(cId) : {}) || {};
        progress.completedLessons = Array.isArray(progress.completedLessons)
          ? progress.completedLessons
          : [];
        const totalLessons = Array.isArray(course.lessons)
          ? course.lessons.length
          : 0;
        const lessonsCompleted = progress.completedLessons.length || 0;
        const quizLength = Array.isArray(course.quiz) ? course.quiz.length : 0;
        const progressPercent =
          typeof calculateCourseProgress === "function"
            ? calculateCourseProgress(cId)
            : 0;
        const quizScore =
          progress.quizScore === null || progress.quizScore === undefined
            ? null
            : progress.quizScore;
        const quizPassed =
          quizScore !== null &&
          quizScore >= (typeof PASS_SCORE !== "undefined" ? PASS_SCORE : 3);
        const isEnrolled =
          Boolean(progress.enrolled) ||
          lessonsCompleted > 0 ||
          quizScore !== null;

        // Last visited link
        const lastVisited = getLastVisited ? getLastVisited(cId) : null;

        // Build curriculum HTML with search bar, bookmarks and notes controls
        const curriculumHtml = `
          <div class="mb-4 flex items-center gap-3">
            <input id="lesson-search" placeholder="Search curriculum..." class="w-full md:w-1/2 px-4 py-2 border rounded focus:ring focus:ring-blue-200 focus:outline-none" />
            <button id="btn-resume" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 ${
              !lastVisited ? "opacity-60 pointer-events-none" : ""
            }">Resume</button>
            <button id="btn-bookmark" title="Bookmark course" class="px-3 py-2 border rounded hover:bg-gray-50"><i class="fas fa-bookmark"></i></button>
            <button id="btn-notes-toggle" title="My notes" class="px-3 py-2 border rounded hover:bg-gray-50"><i class="fas fa-sticky-note"></i></button>
          </div>
          <div id="notes-area" class="mb-4 hidden">
            <textarea id="course-notes" rows="3" placeholder="Write notes about this course..." class="w-full p-3 border rounded-md"></textarea>
            <div class="mt-2 flex gap-2">
              <button id="save-notes" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save Notes</button>
              <button id="clear-notes" class="px-4 py-2 border rounded hover:bg-gray-50">Clear</button>
            </div>
          </div>
          <div id="lessons-list" class="space-y-2">
            ${
              Array.isArray(course.lessons) && course.lessons.length > 0
                ? course.lessons
                    .map((lesson, idx) => {
                      const isDone = progress.completedLessons.includes(
                        lesson.id
                      );
                      const isNext =
                        isEnrolled && !isDone && lessonsCompleted === idx;
                      return `
                <a href="lesson.html?courseId=${cId}&lessonId=${
                        lesson.id
                      }" class="block p-4 rounded-lg transition shadow-sm ${
                        isDone
                          ? "border-l-4 border-green-500 bg-green-50"
                          : isNext
                          ? "border-l-4 border-blue-500 bg-blue-50"
                          : "border bg-gray-50 hover:shadow"
                      }">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <i class="fas ${
                        isDone
                          ? "fa-check-circle text-green-500"
                          : "fa-play-circle text-gray-400"
                      } text-lg"></i>
                      <div>
                        <div class="font-semibold">${escapeHtml(
                          lesson.title
                        )}</div>
                        <div class="text-xs text-gray-500">${escapeHtml(
                          lesson.content?.slice(0, 80) || ""
                        )}...</div>
                      </div>
                    </div>
                    <div class="text-xs text-gray-500">${
                      idx + 1
                    }/${totalLessons}</div>
                  </div>
                </a>
              `;
                    })
                    .join("")
                : `<div class="text-gray-500 p-4">No lessons added yet.</div>`
            }
          </div>
        `;

        container.innerHTML = `
          <div class="bg-white rounded-xl shadow-xl overflow-hidden">
            <div class="md:flex">
              <div class="md:flex-shrink-0">
                <img class="h-64 w-full object-cover md:w-64" src="${escapeHtml(
                  course.image || ""
                )}" alt="${escapeHtml(course.title)}">
              </div>
              <div class="p-8 flex-1">
                <div class="uppercase tracking-wide text-sm text-blue-600 font-bold">${escapeHtml(
                  course.category || "Uncategorized"
                )} • ${escapeHtml(course.level || "N/A")}</div>
                <h1 class="block mt-1 text-4xl leading-tight font-extrabold text-gray-900">${escapeHtml(
                  course.title
                )}</h1>
                <p class="mt-2 text-gray-500 text-lg">${escapeHtml(
                  course.description || ""
                )}</p>
                <div class="mt-4 flex flex-wrap items-center gap-6 text-gray-600">
                  <span class="flex items-center gap-2"><i class="fas fa-clock mr-1"></i> ${escapeHtml(
                    course.duration || "N/A"
                  )}</span>
                  <span class="flex items-center gap-2"><i class="fas fa-list-ul mr-1"></i> ${totalLessons} Lessons</span>
                  <span class="flex items-center gap-2"><i class="fas fa-star text-yellow-500 mr-1"></i> ${
                    course.rating ? course.rating.toFixed(1) : "5.0"
                  } (${course.reviews || 0} reviews)</span>
                </div>
              </div>
            </div>

            <div class="bg-blue-50 p-6 border-t">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-4">
                  <span class="font-semibold text-blue-700">Course Progress</span>
                  <div class="text-sm text-gray-600">${lessonsCompleted} / ${totalLessons} lessons</div>
                </div>
                <div class="font-bold text-blue-800">${progressPercent}%</div>
              </div>

              <div class="w-full bg-blue-200 rounded-full h-3 overflow-hidden">
                <div id="animated-progress" class="bg-blue-600 h-3 rounded-full" style="width:${progressPercent}%; transition: width .9s ease;"></div>
              </div>

              <div id="progress-extra" class="mt-3 text-sm">
                ${
                  quizScore !== null
                    ? quizPassed
                      ? `<span class="text-green-600"><i class="fas fa-medal"></i> Quiz passed: ${quizScore}/${quizLength}</span>`
                      : `<span class="text-red-600"><i class="fas fa-times-circle"></i> Quiz scored: ${quizScore}/${quizLength}</span>`
                    : lessonsCompleted === totalLessons && quizLength > 0
                    ? `<span class="text-orange-600"><i class="fas fa-exclamation-circle"></i> All lessons complete — Final quiz available</span>`
                    : `<span class="text-gray-600">Complete lessons & take the quiz to earn a certificate</span>`
                }
              </div>
            </div>

            <div class="p-6 border-t flex justify-between items-center gap-4">
              <div>${
                isEnrolled
                  ? `<span class="text-sm text-gray-600">You are enrolled</span>`
                  : `<span class="text-sm text-gray-600">Not enrolled</span>`
              }</div>
              <div class="flex items-center gap-3">
                ${
                  isEnrolled && quizScore !== null && quizPassed
                    ? `<button id="btn-view-cert" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Certificate</button>`
                    : ""
                }
                ${
                  isEnrolled
                    ? `<a href="lesson.html?courseId=${cId}&lessonId=${
                        lastVisited || course.lessons?.[0]?.id || 1
                      }" class="px-4 py-2 border rounded hover:bg-gray-50">Go to Lessons</a>`
                    : `<button id="enroll-start-btn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Enroll & Start</button>`
                }
              </div>
            </div>

            <div class="p-8 border-t">
              <h2 class="text-2xl font-bold mb-4">Curriculum</h2>
              ${curriculumHtml}
            </div>
          </div>
        `;

        // Post-render wiring:
        setupCurriculumControls();
        wireCertificateButton(); // attach cert UI if present

        // Enroll button wiring (use centralized enrollAndStart if available)
        const enrollBtn = document.getElementById("enroll-start-btn");
        if (enrollBtn) {
          enrollBtn.addEventListener("click", () => {
            if (typeof window.enrollAndStart === "function") {
              window.enrollAndStart(cId);
            } else {
              // fallback: minimal enroll implementation (defensive)
              if (!getCurrentUser()) {
                alert("You must be logged in to enroll.");
                window.location.href = "login.html";
                return;
              }
              if (typeof enrollInCourse === "function") enrollInCourse(cId);
              const firstLessonId = course.lessons?.[0]?.id || 1;
              saveLastVisited(cId, firstLessonId);
              window.location.href = `lesson.html?courseId=${cId}&lessonId=${firstLessonId}`;
            }
          });
        }

        // If certId present in URL, try to show a verification modal (read-only) after render
        if (certIdQuery) {
          setTimeout(() => {
            // use centralized search
            try {
              const found =
                typeof findCertificateById === "function"
                  ? findCertificateById(certIdQuery)
                  : null;
              if (!found || !found.valid) {
                alert("Certificate not found or invalid.");
                return;
              }
              // Ensure it belongs to this course (defensive)
              if (found.cert.courseId !== cId) {
                alert("Certificate does not correspond to this course.");
                return;
              }
              // open modal populated with that certificate
              openCertificateModalForRecord(found.cert, found.user);
            } catch (e) {
              console.warn("verify flow failed", e);
            }
          }, 400);
        }
      }

      // Save/read notes helpers
      function notesKey(courseId) {
        if (!currentUser) return `course_notes_${courseId}_guest`;
        return `course_notes_${courseId}_${currentUser.email}`;
      }

      function setupCurriculumControls() {
        const searchInput = document.getElementById("lesson-search");
        const lessonsList = document.getElementById("lessons-list");
        const notesArea = document.getElementById("notes-area");
        const notesTextarea = document.getElementById("course-notes");
        const btnNotesToggle = document.getElementById("btn-notes-toggle");
        const btnSaveNotes = document.getElementById("save-notes");
        const btnClearNotes = document.getElementById("clear-notes");
        const btnBookmark = document.getElementById("btn-bookmark");
        const btnResume = document.getElementById("btn-resume");

        // prefill notes if any (guard textarea existence)
        try {
          const existing = localStorage.getItem(notesKey(cId));
          if (existing && notesTextarea) notesTextarea.value = existing;
        } catch (e) {}

        if (btnNotesToggle && notesArea) {
          btnNotesToggle.addEventListener("click", () => {
            notesArea.classList.toggle("hidden");
          });
        }

        if (btnSaveNotes && notesTextarea) {
          btnSaveNotes.addEventListener("click", () => {
            try {
              localStorage.setItem(notesKey(cId), notesTextarea.value || "");
              alert("Notes saved locally in your browser.");
            } catch (e) {
              console.warn("Failed to save notes:", e);
              alert("Could not save notes (localStorage blocked).");
            }
          });
        }

        if (btnClearNotes && notesTextarea) {
          btnClearNotes.addEventListener("click", () => {
            if (!confirm("Clear your notes for this course?")) return;
            notesTextarea.value = "";
            localStorage.removeItem(notesKey(cId));
            alert("Notes cleared.");
          });
        }

        if (btnBookmark) {
          btnBookmark.addEventListener("click", () => {
            if (!currentUser) {
              alert("Please log in to bookmark this course.");
              return;
            }
            const bmKey = `bookmarks_${currentUser.email}`;
            const existing = JSON.parse(localStorage.getItem(bmKey) || "[]");
            if (existing.includes(cId)) {
              alert("Course already bookmarked.");
              return;
            }
            existing.push(cId);
            localStorage.setItem(bmKey, JSON.stringify(existing));
            alert(
              "Bookmarked! You can find it on your dashboard (if implemented)."
            );
          });
        }

        // Resume button
        if (btnResume) {
          btnResume.addEventListener("click", () => {
            const last = getLastVisited && getLastVisited(cId);
            if (last) {
              window.location.href = `lesson.html?courseId=${cId}&lessonId=${last}`;
            } else {
              window.location.href = `lesson.html?courseId=${cId}&lessonId=${
                course.lessons?.[0]?.id || 1
              }`;
            }
          });
        }

        // search filter
        if (searchInput && lessonsList) {
          searchInput.addEventListener("input", (e) => {
            const q = (e.target.value || "").toLowerCase();
            const nodes = lessonsList.querySelectorAll("a");
            nodes.forEach((node) => {
              const text = node.innerText.toLowerCase();
              node.style.display = text.includes(q) ? "" : "none";
            });
          });
        }
      }

      // Wire certificate button (reads centralized progress/cert records)
      function wireCertificateButton() {
        const btn = document.getElementById("btn-view-cert");
        if (!btn) return;

        // ensure single listener by replacing handler
        btn.replaceWith(btn.cloneNode(true));
        const newBtn = document.getElementById("btn-view-cert");

        if (!newBtn) return;
        newBtn.addEventListener("click", () => {
          // Use current user's progress to find certificate record (last one)
          try {
            const progress =
              typeof getProgress === "function" ? getProgress(cId) : {};
            const certificates =
              progress && Array.isArray(progress.certificates)
                ? progress.certificates
                : [];
            if (!certificates || certificates.length === 0) {
              alert(
                "Certificate record not found locally yet. Please visit your Dashboard to view certificates."
              );
              window.location.href = "dashboard.html";
              return;
            }
            const cert = certificates[certificates.length - 1];
            openCertificateModalForRecord(cert, {
              name: currentUser ? currentUser.name : "Student",
              email: currentUser ? currentUser.email : null,
            });
          } catch (e) {
            console.warn("Failed to open certificate modal:", e);
            alert("Unable to open certificate. Try Dashboard instead.");
            window.location.href = "dashboard.html";
          }
        });
      }

      // Build and open the certificate modal for a given certificate record (read-only)
      function openCertificateModalForRecord(certRecord, userObj) {
        // create modal if not already present
        let modal = document.getElementById("certificate-modal");
        if (!modal) {
          const html = `
            <div id="certificate-modal" class="fixed inset-0 bg-black bg-opacity-60 modal-hidden items-center justify-center p-4 z-[110]">
              <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 relative">
                <button id="cert-close" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 text-2xl"><i class="fas fa-times-circle"></i></button>
                <div class="flex flex-col md:flex-row gap-6">
                  <div class="flex-1">
                    <div id="certificate-preview" class="p-10 border-8 border-double border-blue-600 rounded-lg text-center bg-white" style="min-height:280px;">
                      <p class="text-xl text-gray-500 mb-2">CERTIFICATE OF COMPLETION</p>
                      <h1 class="text-5xl font-serif text-blue-800 mb-6 font-extrabold">EduPro</h1>
                      <p class="text-2xl font-light italic mb-4">This certificate is proudly presented to</p>
                      <div id="cert-student-name" class="text-3xl font-semibold text-green-600 mb-2 text-center">${escapeHtml(
                        userObj.name || "Student"
                      )}</div>
                      <p class="text-xl mb-6">for successfully completing the course</p>
                      <h3 id="cert-course-title" class="text-3xl font-bold text-gray-800">...</h3>
                      <div class="mt-8 text-lg text-gray-700 flex justify-center space-x-8">
                        <span>Date: <span id="cert-date" class="font-bold">...</span></span>
                        <span>Score: <span id="cert-score" class="font-bold">...</span></span>
                      </div>
                      <div class="mt-6 text-xs text-gray-400">Certificate ID: <span id="cert-id" class="font-mono"></span></div>
                      <p class="mt-8 text-sm text-gray-400">Instructor Signature: John Doe</p>
                    </div>
                    <p class="text-sm text-gray-500 mt-3">You can download or print this certificate using the actions on the right.</p>
                  </div>

                  <div class="w-full md:w-80 flex flex-col gap-3">
                    <div class="bg-gray-50 border rounded p-3">
                      <div class="font-semibold mb-1">Certificate Actions</div>
                      <div class="flex flex-col gap-2">
                        <button id="cert-download-pdf" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Download PDF</button>
                        <button id="cert-print" class="px-3 py-2 border rounded hover:bg-gray-50">Print</button>
                        <button id="cert-copy-link" class="px-3 py-2 border rounded hover:bg-gray-50">Copy Certificate Link</button>
                        <a id="cert-dashboard-link" class="block text-center text-sm text-gray-600 mt-2 hover:underline" href="dashboard.html">Open in Dashboard</a>
                      </div>
                    </div>

                    <div class="bg-gray-50 border rounded p-3">
                      <div class="font-semibold mb-1">Verification</div>
                      <div class="text-sm text-gray-600">Share the certificate link or the ID to verify ownership in EduPro.</div>
                    </div>

                    <div class="bg-gray-50 border rounded p-3">
                      <div class="font-semibold mb-1">Safety</div>
                      <div class="text-sm text-gray-600">Certificates are stored in your account (local demo). In production you'd verify server-side.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          document.body.insertAdjacentHTML("beforeend", html);
          modal = document.getElementById("certificate-modal");

          // close handler (attach once)
          document.addEventListener("click", (e) => {
            const modalEl = document.getElementById("certificate-modal");
            if (!modalEl) return;
            const target = e.target;
            if (
              target.id === "cert-close" ||
              (target.closest && target.closest("#cert-close"))
            ) {
              modalEl.classList.add("modal-hidden");
              modalEl.classList.remove("modal-flex");
            }
          });
        }

        // populate fields
        const courseTitleNode = document.getElementById("cert-course-title");
        const dateNode = document.getElementById("cert-date");
        const scoreNode = document.getElementById("cert-score");
        const idNode = document.getElementById("cert-id");
        const studentNameNode = document.getElementById("cert-student-name");

        if (courseTitleNode)
          courseTitleNode.innerText = escapeHtml(
            certRecord.courseTitle || course.title || ""
          );
        if (dateNode)
          dateNode.innerText = new Date(
            certRecord.issuedOn
          ).toLocaleDateString();
        if (scoreNode)
          scoreNode.innerText = `${certRecord.score}/${
            (course.quiz || []).length
          }`;
        if (idNode) idNode.innerText = certRecord.id;
        if (studentNameNode)
          studentNameNode.innerText = escapeHtml(
            userObj.name || (currentUser && currentUser.name) || "Student"
          );

        // wire actions (replace handlers to avoid duplicates)
        const dlp = document.getElementById("cert-download-pdf");
        const prn = document.getElementById("cert-print");
        const copyBtn = document.getElementById("cert-copy-link");
        const dashLink = document.getElementById("cert-dashboard-link");

        if (dlp) {
          dlp.onclick = () => {
            if (typeof window.downloadCertificatePDF === "function") {
              window.downloadCertificatePDF(cId);
            } else {
              alert("Download is not available.");
            }
          };
        }
        if (prn) {
          prn.onclick = () => {
            if (typeof window.printCertificate === "function") {
              window.printCertificate(cId);
            } else {
              window.print();
            }
          };
        }
        if (copyBtn) {
          copyBtn.onclick = async () => {
            const url = `${location.origin}${
              location.pathname
            }?id=${cId}&certId=${encodeURIComponent(certRecord.id)}`;
            try {
              await navigator.clipboard.writeText(url);
              alert("Certificate link copied to clipboard.");
            } catch (e) {
              prompt("Copy this certificate link:", url);
            }
          };
        }
        if (dashLink) {
          dashLink.onclick = (e) => {
            // default href will work; ensure we don't double-handle
          };
        }

        // show modal
        modal.classList.remove("modal-hidden");
        modal.classList.add("modal-flex");
        setTimeout(() => modal.classList.add("fade-in"), 20);
      }

      // Listen for progressUpdated to update UI live (quiz page dispatches this event)
      window.addEventListener("progressUpdated", (ev) => {
        try {
          const newPercent = calculateCourseProgress(cId);
          const progElem = document.getElementById("animated-progress");
          if (progElem) {
            progElem.style.width = `${newPercent}%`;
            // update numeric percent in header
            const percentNode = document.querySelector(
              "#course-detail-container .font-bold.text-blue-800"
            );
            if (percentNode) percentNode.innerText = `${newPercent}%`;
          }
          // Re-render minimal sections if certificate visibility may have changed.
          setTimeout(() => {
            const btn = document.getElementById("btn-view-cert");
            const shouldHaveBtn =
              calculateCourseProgress(cId) === 100 &&
              getProgress(cId).quizScore !== null &&
              getProgress(cId).quizScore >=
                (typeof PASS_SCORE !== "undefined" ? PASS_SCORE : 3);
            if (!btn && shouldHaveBtn) {
              // re-render to add the button (safe minimal re-render)
              renderCourseDetail();
            }
          }, 80);
        } catch (err) {
          console.warn("progressUpdated handler error", err);
        }
      });

      // initial render
      setTimeout(renderCourseDetail, 50);
    </script>

    <!-- NOTE: certificate modal is generated on-demand by the page script above -->
  </body>
</html>
